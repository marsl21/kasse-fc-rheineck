<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FCR Kiosk Kasse</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#7a8aa0; --text:#e8eef8; --accent:#e53935; --ok:#23c55e;
      --brand:#c21c2c; /* FCR Rot Touch */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b1220,#0e1526 60%,#0b1220);color:var(--text)}
    .wrap{max-width:1500px;margin-inline:auto;padding:16px 12px 120px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0;letter-spacing:.3px}
    .badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:12px}
    .cols{grid-template-columns:1fr}
    @media(min-width:980px){.cols{grid-template-columns:1.6fr .4fr}}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:16px;margin:0 0 8px 0}
    .card .content{padding:14px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="date"], select, input[type="text"]{background:#0e1628;border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:600;color:#fff;cursor:pointer;transition:transform .02s ease, opacity .2s}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .btn.primary{background:linear-gradient(180deg,#e63b3b,#b91c1c)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a)}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--muted)}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    .btn.muted{background:#1b2338;color:#c9d4e5;border:1px solid rgba(255,255,255,.12)}

    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    @media(min-width:560px){.items{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}}
    @media(min-width:1200px){.items{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
    .item{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .item .name{font-weight:700}
    .item .price{font-size:14px;color:#cdd6e6}
    .item .add{margin-top:auto}

    .cart-list,.sales-list{list-style:none;margin:0;padding:0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .row:last-child{border-bottom:none}
    .row .left{display:flex;align-items:center;gap:8px}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#1b2742;border:1px solid rgba(255,255,255,.12);color:#cfe0ff}
    .total{display:flex;align-items:center;justify-content:space-between;padding:10px 0;font-weight:800;font-size:20px}

    .pill{display:inline-flex;align-items:center;gap:8px;background:#0f1a30;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:10px 12px}
    .pill .dot{width:8px;height:8px;border-radius:999px}

    .muted{color:#9aacc6}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FCR Kiosk Kasse</h1>
      <span class="badge" id="statusBadge">Kein Tag geöffnet</span>
    </header>

    <div class="grid cols">
      <!-- Linke Spalte: Artikel-Buttons -->
      <section class="card">
        <div class="content">
          <h2>Tag eröffnen</h2>
          <div class="toolbar" style="margin-bottom:10px">
            <input type="date" id="dayInput" />
            <button class="btn primary" id="openDayBtn">Tag eröffnen</button>
            <span class="pill small" id="salesCountPill" title="Anzahl Verkäufe heute">
              <span class="dot" style="background:#22c55e"></span><span id="salesCount">0</span> Verkäufe
            </span>
          </div>

          <div class="divider"></div>

          <h2>Artikel</h2>
          <div class="items" id="items"></div>
        </div>
      </section>

      <!-- Rechte Spalte: Warenkorb + Tagesliste -->
      <section class="card">
        <div class="content">
          <h2>Aktueller Bon</h2>
          <ul class="cart-list" id="cart"></ul>
          <div class="total"><span>Total</span><span id="cartTotal" class="mono">CHF 0.00</span></div>
          <div class="toolbar">
            <button class="btn ok" id="payBtn" disabled>Bezahlt</button>
            <button class="btn warn" id="undoBtn" disabled>Letzte Position zurück</button>
            <button class="btn ghost" id="clearCartBtn" disabled>Bon leeren</button>
          </div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="content">
          <h2>Tagesliste</h2>
          <ul class="sales-list" id="sales"></ul>
          <div class="divider"></div>
          <div class="toolbar">
            <button class="btn muted" id="summaryBtn" disabled>Zusammenfassung anzeigen</button>
            <button class="btn" id="exportBtn" disabled>Zu Google Sheets speichern</button>
            <button class="btn ghost" id="resetDayBtn" disabled>Tag zurücksetzen</button>
          </div>
          <p class="small muted" style="margin-top:8px">Hinweis: Speichern zu Google Sheets erfordert die Einrichtung eines Webhooks (siehe Kommentar im Code). "Tag zurücksetzen" löscht lokale Tagesdaten. <strong>Achtung: erst nach Abschluss zurücksetzen!</strong></p>
        </div>
      </section>
    </div>
  </div>

<script>
/*********************************
 * KONFIGURATION: ARTIKEL & PREISE
 *********************************/
const CATALOG = [
  { name:'Bier Gross',   price: 5.50 },
  { name:'Bier Klein',   price: 3.50 },
  { name:'Café',         price: 4.00 },
  { name:'Pommes',       price: 6.00 },
  { name:'Burger',       price:11.00 },
  { name:'Cheeseburger', price:12.00 },
  // ➜ Hier kannst du jederzeit erweitern (Name/Preis)
  // Beispiel: { name:'Mineral', price:3.50 }, { name:'Coca Cola', price:4.00 }, ...
];

const CHF = new Intl.NumberFormat('de-CH',{style:'currency',currency:'CHF'});

/*********************************
 * GOOGLE SHEETS WEBHOOK (Apps Script)
 * 1) Erstelle ein Google Sheet (z.B. "FCR Kasse Tagesliste").
 * 2) Extensions → Apps Script: folgenden Code einsetzen und als Web-App deployen (siehe Chat-Anleitung).
 * 3) URL hier eintragen:
 *********************************/
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwZ9gIlrNrHOEVGFC7TmDZHFO3InykjdwJ31zeGtN3N6E0e71Gulaq8Tc8nZvF4p6mN/exec"

/*********************
 * STORAGE (localStorage)
 *********************/
function keyForDay(day){ return `fcrkiosk:${day}`; }
function loadDay(day){
  const raw = localStorage.getItem(keyForDay(day));
  return raw ? JSON.parse(raw) : { meta:{ openedAt:new Date().toISOString() }, sales:[] };
}
function saveDay(day, data){ localStorage.setItem(keyForDay(day), JSON.stringify(data)); }
function clearDay(day){ localStorage.removeItem(keyForDay(day)); }

/*********************
 * APP STATE
 *********************/
let currentDay = null; // string YYYY-MM-DD
let dayData = null;    // {meta, sales}
let cart = [];         // [{name, price, qty}]

/*********************
 * UI HELPERS
 *********************/
function setBadge(text){ document.getElementById('statusBadge').textContent = text; }
function setButtonsEnabled(isOpen){
  document.getElementById('payBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('undoBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('clearCartBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('exportBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
  document.getElementById('resetDayBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
  document.getElementById('summaryBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
}
function todayStr(){ return new Date().toISOString().slice(0,10); }

/*********************
 * RENDER: Artikel-Buttons
 *********************/
function renderItems(){
  const wrap = document.getElementById('items');
  wrap.innerHTML = '';
  CATALOG.forEach((item)=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="name">${item.name}</div>
      <div class="price">${CHF.format(item.price)}</div>
      <div class="toolbar"><button class="btn muted add" style="width:100%">Hinzufügen</button></div>`;
    el.querySelector('.add').onclick = ()=> addToCart(item, 1);
    wrap.appendChild(el);
  });
}

/*********************
 * CART
 *********************/
function addToCart(item, qty=1){
  const idx = cart.findIndex(x=>x.name===item.name && x.price===item.price);
  if(idx>=0){ cart[idx].qty += qty; }
  else { cart.push({name:item.name, price:item.price, qty}); }
  renderCart();
}
function undoLast(){ cart.pop(); renderCart(); }
function clearCart(){ cart = []; renderCart(); }
function cartTotal(){ return cart.reduce((s,x)=> s + x.price*x.qty, 0); }
function renderCart(){
  const list = document.getElementById('cart');
  list.innerHTML = '';
  cart.forEach((x)=>{
    const li = document.createElement('li');
    li.className='row';
    li.innerHTML = `
      <div class="left">
        <span class="chip">${x.qty}×</span>
        <div>
          <div>${x.name}</div>
          <div class="small muted">à ${CHF.format(x.price)}</div>
        </div>
      </div>
      <div class="mono">${CHF.format(x.price*x.qty)}</div>`;
    list.appendChild(li);
  });
  document.getElementById('cartTotal').textContent = CHF.format(cartTotal());
  document.getElementById('salesCount').textContent = String(dayData?.sales?.length||0);
  setButtonsEnabled(!!currentDay);
}

/*********************
 * SALES (Tagesliste)
 *********************/
function newBonId(){
  // YYYYMMDD-HHMMSS-rrrr
  const d = new Date();
  const pad = n=> String(n).padStart(2,'0');
  const id = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.floor(Math.random()*9000+1000)}`;
  return id;
}
function pay(){
  if(!currentDay || cart.length===0) return;
  const id = newBonId();
  const ts = new Date().toISOString();
  const lines = cart.map(x=>({ id, ts, item:x.name, qty:x.qty, price:x.price, total: +(x.price*x.qty).toFixed(2) }));
  dayData.sales.push(...lines);
  saveDay(currentDay, dayData);
  appendSales(lines);
  clearCart();
}
function appendSales(lines){
  const list = document.getElementById('sales');
  const time = (s)=> new Date(s).toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'});
  const groupTotal = lines.reduce((s,x)=> s+x.total, 0);
  const container = document.createElement('li');
  container.innerHTML = `
    <div class="row"><div class="left"><span class="chip">Bon</span><strong>${lines[0].id}</strong></div><div class="mono">${CHF.format(groupTotal)}</div></div>`;
  lines.forEach(x=>{
    const li = document.createElement('div');
    li.className='row';
    li.innerHTML = `<div class="left"><span class="chip">${time(x.ts)}</span>${x.qty}× ${x.item}</div><div class="mono">${CHF.format(x.total)}</div>`;
    container.appendChild(li);
  });
  list.prepend(container);
  document.getElementById('salesCount').textContent = String(dayData?.sales?.length||0);
  setButtonsEnabled(!!currentDay);
}
function renderAllSales(){
  const byBon = new Map();
  for(const line of (dayData?.sales||[])){
    if(!byBon.has(line.id)) byBon.set(line.id, []);
    byBon.get(line.id).push(line);
  }
  const arr = Array.from(byBon.values()).sort((a,b)=> b[0].ts.localeCompare(a[0].ts));
  const list = document.getElementById('sales');
  list.innerHTML = '';
  arr.forEach(lines=> appendSales(lines));
}

/*********************
 * EXPORT → GOOGLE SHEETS
 *********************/
async function exportToSheets(){
  if(!currentDay) return;
  if(!WEBHOOK_URL){ alert('Kein Google-Webhook konfiguriert. Bitte WEBHOOK_URL im Code setzen.'); return; }
  const payload = { day: currentDay, sales: dayData.sales };
  try{
    const res = await fetch(WEBHOOK_URL, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const json = await res.json().catch(()=>({}));
    alert('Zu Google Sheets gespeichert. '+ (json.inserted? (json.inserted+ ' Zeilen eingefügt.') : ''));
  }catch(err){
    alert('Fehler beim Speichern zu Google Sheets: '+err.message+'\nBitte prüfe die Web-App-URL und Berechtigungen.');
  }
}

/*********************
 * DAY OPEN/RESET
 *********************/
function openDay(day){
  currentDay = day;
  dayData = loadDay(day);
  setBadge(`Tag geöffnet: ${day}`);
  document.getElementById('exportBtn').disabled = (dayData.sales.length===0);
  document.getElementById('resetDayBtn').disabled = (dayData.sales.length===0);
  document.getElementById('summaryBtn').disabled = (dayData.sales.length===0);
  renderAllSales();
  renderCart();
}
function resetDay(){
  if(!currentDay) return;
  if(!confirm('Achtung: erst nach Abschluss zurücksetzen!\nWillst du den Tag wirklich löschen? (alle Verkäufe werden entfernt)')) return;
  clearDay(currentDay);
  dayData = { meta:{ openedAt:new Date().toISOString() }, sales:[] };
  saveDay(currentDay, dayData);
  renderAllSales();
  renderCart();
}

/*********************
 * INIT
 *********************/
function init(){
  // Heute als Default im Datepicker
  document.getElementById('dayInput').value = todayStr();
  renderItems();
  renderCart();

  document.getElementById('openDayBtn').onclick = ()=>{
    const v = document.getElementById('dayInput').value || todayStr();
    openDay(v);
  };

  document.getElementById('payBtn').onclick = ()=> pay();
  document.getElementById('undoBtn').onclick = ()=> undoLast();
  document.getElementById('clearCartBtn').onclick = ()=> clearCart();

  document.getElementById('exportBtn').onclick = ()=> exportToSheets();
  document.getElementById('summaryBtn').onclick = ()=> showSummary();
  document.getElementById('resetDayBtn').onclick = ()=> resetDay();
}

/*********************
 * SUMMARY (Anzeige)
 *********************/
function showSummary(){
  const sum = {};
  let grand=0;
  for(const r of dayData.sales){
    sum[r.item] = (sum[r.item]||0) + r.total;
    grand += r.total;
  }
  const lines = Object.entries(sum).sort((a,b)=> b[1]-a[1]).map(([k,v])=> `${k}: ${CHF.format(v)}`).join('\n');
  alert((lines||'Keine Verkäufe')+"\n\nTotal: "+CHF.format(grand));
}

init();
</script>
</body>
</html>
