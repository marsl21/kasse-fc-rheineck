<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FCR Kiosk Kasse</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --tile:#1a2746;          /* helleres Blau für Artikel-Kacheln */
      --tile-hover:#22335a;    /* Hover/Fokus */
      --tile-active:#2a3f71;   /* Active */
      --muted:#9ab0cf; --text:#ffffff; --accent:#e53935; --ok:#23c55e;
      --brand:#c21c2c; /* FCR Rot Touch */
      --tile-drinks:#233a70;       /* Getränke heller */
      --tile-drinks-hover:#2b4584;
      --tile-drinks-active:#36529b;
     --tile-food:#6b1d1d;         /* Grundton (dunkles Rot) */
     --tile-food-hover:#7f2525;   /* Hover */
    --tile-food-active:#8f2d2d;  /* Active */


    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,var(--bg),#0e1526 60%,var(--bg));color:var(--text)}
    .wrap{max-width:1500px;margin-inline:auto;padding:16px 12px 120px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0;letter-spacing:.3px}
    .badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:12px}
    .cols{grid-template-columns:1fr}
    @media(min-width:980px){.cols{grid-template-columns:1.6fr .4fr}}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:16px;margin:0 0 8px 0}
    .card .content{padding:14px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="date"], select, input[type="text"]{background:#0e1628;border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:600;color:#fff;cursor:pointer;transition:transform .02s ease, opacity .2s}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .btn.primary{background:linear-gradient(180deg,#e63b3b,#b91c1c)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a)}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:#7a8aa0}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    .btn.muted{background:#1b2338;color:#c9d4e5;border:1px solid rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);color:#fff}

    .group{margin-bottom:12px}
    .group-title{margin:8px 4px 8px;font-weight:800;letter-spacing:.3px;color:#dbe7ff;opacity:.9}
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px}
    @media(min-width:560px){.items{grid-template-columns:repeat(auto-fill,minmax(190px,1fr))}}
    @media(min-width:1200px){.items{grid-template-columns:repeat(auto-fill,minmax(210px,1fr))}}

    .item{background:var(--tile);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:16px 14px;display:flex;flex-direction:column;gap:6px;cursor:pointer;user-select:none;outline:none}
    .item:hover{background:var(--tile-hover)}
    .item:active{background:var(--tile-active)}
    .item:focus-visible{box-shadow:0 0 0 3px rgba(255,255,255,.18)}
    .item .name{font-weight:900;letter-spacing:.2px;font-size:18px;color:#ffffff}
    .item .price{font-size:14px;color:#cdd6e6}

    /* Gruppe Getränke heller einfärben */
    .group[data-name="Getränke"] .item{background:var(--tile-drinks)}
    .group[data-name="Getränke"] .item:hover{background:var(--tile-drinks-hover)}
    .group[data-name="Getränke"] .item:active{background:var(--tile-drinks-active)}
   
    /* Gruppe Essen rot einfärben */
    .group[data-name="Essen"] .item{background:var(--tile-food)}
    .group[data-name="Essen"] .item:hover{background:var(--tile-food-hover)}
    .group[data-name="Essen"] .item:active{background:var(--tile-food-active)}


    .cart-list,.sales-list{list-style:none;margin:0;padding:0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .row:last-child{border-bottom:none}
    .row .left{display:flex;align-items:center;gap:8px}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#facc15;border:1px solid #eab308;color:#111111;font-weight:700}
    .total{display:flex;align-items:center;justify-content:space-between;padding:10px 0;font-weight:800;font-size:20px}

    .pill{display:inline-flex;align-items:center;gap:8px;background:#0f1a30;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:10px 12px}
    .pill .dot{width:8px;height:8px;border-radius:999px}

    .muted{color:#9aacc6}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:8px 0}
    /* Grosse Buttons rechts */
    .btn.lg{font-size:16px;padding:16px 18px;border-radius:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FCR Kiosk Kasse</h1>
      <span class="badge" id="statusBadge">Kein Tag geöffnet</span>
    </header>

    <div class="grid cols">
      <!-- Linke Spalte: Artikel-Buttons -->
      <section class="card">
        <div class="content">
          <h2>Tag eröffnen</h2>
          <div class="toolbar" style="margin-bottom:10px">
            <input type="date" id="dayInput" />
            <button class="btn primary" id="openDayBtn">Tag eröffnen</button>
            <span class="pill small" id="salesCountPill" title="Anzahl Verkäufe heute">
              <span class="dot" style="background:#22c55e"></span><span id="salesCount">0</span> Verkäufe
            </span>
          </div>

          <div class="divider"></div>

          <div id="catalog"></div>
        </div>
      </section>

      <!-- Rechte Spalte: Warenkorb + Tagesliste -->
      <section class="card">
        <div class="content">
          <h2>Aktueller Bon</h2>
          <ul class="cart-list" id="cart"></ul>
          <div class="total"><span>Total</span><span id="cartTotal" class="mono">CHF 0.00</span></div>
          <div class="toolbar">
            <button class="btn ok lg" id="payBtn" disabled>Bezahlt</button>
            <button class="btn warn lg" id="undoBtn" disabled>Letzte Position zurück</button>
            <button class="btn ghost lg" id="clearCartBtn" disabled>Bon leeren</button>
          </div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="content">
          <h2>Tagesliste</h2>
          <ul class="sales-list" id="sales"></ul>
          <div class="divider"></div>
          <div class="toolbar">
            <button class="btn muted" id="summaryBtn" disabled>Zusammenfassung anzeigen</button>
            <button class="btn danger" id="exportBtn" disabled>Tagesabschluss</button>
            <button class="btn ghost" id="resetDayBtn" disabled>Tag zurücksetzen</button>
          </div>
          <p class="small muted" style="margin-top:8px">Hinweis: "Tag zurücksetzen" löscht alle Tagesdaten von heute! <strong>Achtung: erst nach Tagesabschluss zurücksetzen!</strong></p>
        </div>
      </section>
    </div>
  </div>

<script>
/*********************************
 * KONFIGURATION: ARTIKEL & PREISE (mit Gruppen)
 *********************************/
const CATALOG = {
  'Getränke': [
    { name:'Mineral klein',  price: 2.50 },
    { name:'Mineral GROSS',  price: 4.00 },
    { name:'Softgetränk klein',  price: 3.00 },
    { name:'Softetränk GROSS',  price: 4.50 },
    { name:'Capri Sonne',    price: 1.00 },
    { name:'Bier klein',     price: 3.50 },
    { name:'Bier GROSS',     price: 5.50 },
    { name:'Saft vom Fass',  price: 4.00 },
    { name:'Tee/Punsch',  price: 3.00 },
    { name:'Café',  price: 4.00 },
    { name:'RedBull',  price: 4.00 },
    { name:'Smirnoff',  price: 4.00 },
    { name:'Apérol Spritz',  price: 9.00 },
    { name:'Mojito',  price: 9.00 },
    { name:'Shots',  price: 4.00 },
    { name:'Wein Glas',  price: 3.00 },
    { name:'Weisswein Flasche',  price: 20.00 },
    { name:'Rotwein Flasche',  price: 25.00 },
    { name:'1 Meter Luft',  price: 15.00 },
    { name:'Harass Bier',  price: 70.00 },
  ],
  'Essen': [
    { name:'Bratwurst',  price: 7.00 },
    { name:'Röbis FC-Wurst',  price: 7.00 },
    { name:'Hamburger',      price:11.00 },
    { name:'Cheeseburger',   price:12.00 },
    { name:'Poulet-Flügeli',  price: 13.00 },
    { name:'Schnitzelbrot',  price: 7.00 },
    { name:'Pommes',         price: 5.00 },
    { name:'Nuggets',         price: 6.00 },
    { name:'Currywurst', price: 8.00 },
    { name:'Fleischkäse Bürli', price: 5.50 },
  ],
  'Snacks': [
   { name:'Glacé',    price: 5.00 },
   { name:'Süsses/Salziges', price: 0.50 },
   { name:'Süsses/Salziges', price: 1.00 },
   { name:'-1 CHF', price: -1.00 },
   { name:'+1 CHF', price: 1.00 },
  ]
};

const CHF = new Intl.NumberFormat('de-CH',{style:'currency',currency:'CHF'});

/*********************************
 * GOOGLE SHEETS WEBHOOK (Apps Script)
 *********************************/
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbx4-301v8V-8V3tulg-UIou1R6J2MDb-IzMplFbArkdy6Df54Hk631UwhBOgBVj6KOO/exec"; // deine /macros/s/.../exec URL

/*********************
 * STORAGE (localStorage)
 *********************/
function keyForDay(day){ return `fcrkiosk:${day}`; }
function loadDay(day){
  const raw = localStorage.getItem(keyForDay(day));
  return raw ? JSON.parse(raw) : { meta:{ openedAt:new Date().toISOString() }, sales:[] };
}
function saveDay(day, data){ localStorage.setItem(keyForDay(day), JSON.stringify(data)); }
function clearDay(day){ localStorage.removeItem(keyForDay(day)); }

/*********************
 * APP STATE
 *********************/
let currentDay = null; // string YYYY-MM-DD
let dayData = null;    // {meta, sales}
let cart = [];         // [{name, price, qty}]

/*********************
 * UI HELPERS
 *********************/
function setBadge(text){ document.getElementById('statusBadge').textContent = text; }
function setButtonsEnabled(isOpen){
  document.getElementById('payBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('undoBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('clearCartBtn').disabled = !isOpen || cart.length===0;
  document.getElementById('exportBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
  document.getElementById('resetDayBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
  document.getElementById('summaryBtn').disabled = !isOpen || (dayData?.sales?.length||0)===0;
}
function todayStr(){ return new Date().toISOString().slice(0,10); }

/*********************
 * RENDER: Artikel-Gruppen & Kacheln
 *********************/
function renderItems(){
  const root = document.getElementById('catalog');
  root.innerHTML = '';
  for(const [group, items] of Object.entries(CATALOG)){
    const section = document.createElement('section');
    section.className = 'group';
    section.dataset.name = group;
    const title = document.createElement('div');
    title.className = 'group-title';
    title.textContent = group;
    const grid = document.createElement('div');
    grid.className = 'items';

    items.forEach(item=>{
      const btn = document.createElement('button');
      btn.className = 'item';
      btn.type = 'button';
      btn.setAttribute('aria-label', `${item.name} hinzufügen`);
      btn.innerHTML = `<div class="name">${item.name}</div><div class="price">${CHF.format(item.price)}</div>`;
      btn.onclick = ()=> addToCart(item, 1);
      grid.appendChild(btn);
    });

    section.appendChild(title);
    section.appendChild(grid);
    root.appendChild(section);
  }
}

/*********************
 * CART
 *********************/
function addToCart(item, qty=1){
  const idx = cart.findIndex(x=>x.name===item.name && x.price===item.price);
  if(idx>=0){ cart[idx].qty += qty; }
  else { cart.push({name:item.name, price:item.price, qty}); }
  renderCart();
}
function undoLast(){ cart.pop(); renderCart(); }
function clearCart(){ cart = []; renderCart(); }
function cartTotal(){ return cart.reduce((s,x)=> s + x.price*x.qty, 0); }
function renderCart(){
  const list = document.getElementById('cart');
  list.innerHTML = '';
  cart.forEach((x)=>{
    const li = document.createElement('li');
    li.className='row';
    li.innerHTML = `
      <div class="left">
        <span class="chip">${x.qty}×</span>
        <div>
          <div>${x.name}</div>
          <div class="small muted">à ${CHF.format(x.price)}</div>
        </div>
      </div>
      <div class="mono">${CHF.format(x.price*x.qty)}</div>`;
    list.appendChild(li);
  });
  document.getElementById('cartTotal').textContent = CHF.format(cartTotal());
  document.getElementById('salesCount').textContent = String(dayData?.sales?.length||0);
  setButtonsEnabled(!!currentDay);
}

/*********************
 * SALES (Tagesliste)
 *********************/
function newBonId(){
  const d = new Date();
  const pad = n=> String(n).padStart(2,'0');
  const id = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.floor(Math.random()*9000+1000)}`;
  return id;
}
function pay(){
  if(!currentDay || cart.length===0) return;
  const id = newBonId();
  const ts = new Date().toISOString();
  const lines = cart.map(x=>({ id, ts, item:x.name, qty:x.qty, price:x.price, total: +(x.price*x.qty).toFixed(2) }));
  dayData.sales.push(...lines);
  saveDay(currentDay, dayData);
  appendSales(lines);
  clearCart();
}
function appendSales(lines){
  const list = document.getElementById('sales');
  const time = (s)=> new Date(s).toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'});
  const groupTotal = lines.reduce((s,x)=> s+x.total, 0);
  const container = document.createElement('li');
  container.innerHTML = `
    <div class="row"><div class="left"><span class="chip">Bon</span><strong>${lines[0].id}</strong></div><div class="mono">${CHF.format(groupTotal)}</div></div>`;
  lines.forEach(x=>{
    const li = document.createElement('div');
    li.className='row';
    li.innerHTML = `<div class="left"><span class="chip">${time(x.ts)}</span>${x.qty}× ${x.item}</div><div class="mono">${CHF.format(x.total)}</div>`;
    container.appendChild(li);
  });
  list.prepend(container);
  document.getElementById('salesCount').textContent = String(dayData?.sales?.length||0);
  setButtonsEnabled(!!currentDay);
}
function renderAllSales(){
  const byBon = new Map();
  for(const line of (dayData?.sales||[])){
    if(!byBon.has(line.id)) byBon.set(line.id, []);
    byBon.get(line.id).push(line);
  }
  const arr = Array.from(byBon.values()).sort((a,b)=> b[0].ts.localeCompare(a[0].ts));
  const list = document.getElementById('sales');
  list.innerHTML = '';
  arr.forEach(lines=> appendSales(lines));
}

/*********************
 * EXPORT → GOOGLE SHEETS (ohne Preflight)
 *********************/
async function exportToSheets(){
  if(!currentDay) return;
  if(!WEBHOOK_URL){ alert('Kein Google-Webhook konfiguriert. Bitte WEBHOOK_URL im Code setzen.'); return; }
  if(!confirm('Sicher, dass du den Tag abschliessen willst?')) return;
  const payload = { day: currentDay, sales: dayData.sales };
  try{
    const res = await fetch(WEBHOOK_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const json = await res.json().catch(()=>({}));
    alert('Zu Google Sheets gespeichert. '+ (json.inserted? (json.inserted+ ' Zeilen eingefügt.') : ''));
  }catch(err){
    alert('Fehler beim Speichern zu Google Sheets: '+err.message+'\nBitte prüfe die Web-App-URL und Berechtigungen.');
  }
}

/*********************
 * DAY OPEN/RESET
 *********************/
function openDay(day){
  currentDay = day;
  dayData = loadDay(day);
  setBadge(`Tag geöffnet: ${day}`);
  document.getElementById('exportBtn').disabled = (dayData.sales.length===0);
  document.getElementById('resetDayBtn').disabled = (dayData.sales.length===0);
  document.getElementById('summaryBtn').disabled = (dayData.sales.length===0);
  renderAllSales();
  renderCart();
}
function resetDay(){
  if(!currentDay) return;
  if(!confirm('Achtung: erst nach Abschluss zurücksetzen!\nWillst du den Tag wirklich löschen? (alle Verkäufe werden entfernt)')) return;
  clearDay(currentDay);
  dayData = { meta:{ openedAt:new Date().toISOString() }, sales:[] };
  saveDay(currentDay, dayData);
  renderAllSales();
  renderCart();
}

/*********************
 * SUMMARY (Anzeige)
 *********************/
function showSummary(){
  const sum = {};
  let grand=0;
  for(const r of dayData.sales){
    sum[r.item] = (sum[r.item]||0) + r.total;
    grand += r.total;
  }
  const lines = Object.entries(sum).sort((a,b)=> b[1]-a[1]).map(([k,v])=> `${k}: ${CHF.format(v)}`).join('\n');
  alert((lines||'Keine Verkäufe')+"\n\nTotal: "+CHF.format(grand));
}

/*********************
 * INIT
 *********************/
function init(){
  document.getElementById('dayInput').value = todayStr();
  renderItems();
  renderCart();

  document.getElementById('openDayBtn').onclick = ()=>{
    const v = document.getElementById('dayInput').value || todayStr();
    openDay(v);
  };

  document.getElementById('payBtn').onclick = ()=> pay();
  document.getElementById('undoBtn').onclick = ()=> undoLast();
  document.getElementById('clearCartBtn').onclick = ()=> clearCart();

  document.getElementById('exportBtn').onclick = ()=> exportToSheets();
  document.getElementById('summaryBtn').onclick = ()=> showSummary();
  document.getElementById('resetDayBtn').onclick = ()=> resetDay();
}

init();

/*********************
 * SELFTEST (optional): aufrufen mit ?selftest=1 in der URL
 *********************/
(function selftest(){
  try{
    const usp = new URLSearchParams(location.search);
    if(!usp.has('selftest')) return;
    console.log('[Selftest] start');
    const oldFetch = window.fetch;
    const oldConfirm = window.confirm;
    window.fetch = async ()=> new Response(JSON.stringify({ ok:true, inserted:0 }), { status:200, headers:{'Content-Type':'application/json'} });
    window.confirm = ()=> true;
    currentDay = '2099-12-31';
    dayData = { meta:{ openedAt:new Date().toISOString() }, sales:[{ id:'TEST', ts:new Date().toISOString(), item:'Probe', qty:1, price:1.2, total:1.2 }] };
    exportToSheets().then(()=> console.log('[Selftest] OK')).catch(e=> console.error('[Selftest] FAIL', e)).finally(()=>{
      window.fetch = oldFetch; window.confirm = oldConfirm;
    });
  }catch(e){ console.error('[Selftest] error', e); }
})();
</script>
</body>
</html>